(function(){"use strict";const P="https://chessboardjs.com/img/chesspieces/wikipedia/{piece}.png",S=/^([O0]-[O0](-[O0])?[+#]?|[KQRBN]?[a-h]?[1-8]?x?[a-h][1-8](=[QRBN])?[+#]?|[a-h][1-8](=[QRBN])?[+#]?)$/,R=/^(1-0|0-1|1\/2-1\/2|½-½|\*)$/,M=/^(\d+)(\.+)$/;let g=0;function h(){if(typeof Chess=="undefined"){console.warn("pgn.js: chess.js missing");return!1}return!0}function A(e){return e?e.replace(/1\/2-1\/2/g,"½-½"):""}function E(e){if(!e)return"";const t=e.split(".");return/^\d{4}$/.test(t[0])?t[0]:""}function T(e){if(!e)return"";const t=e.indexOf(",");return t===-1?e.trim():e.substring(t+1).trim()+" "+e.substring(0,t).trim()}function a(e,t){t&&e.appendChild(document.createTextNode(t))}function D(e,t){if(typeof Chessboard=="undefined"){console.warn("pgn.js: chessboard.js missing for diagrams");return}const n="pgn-diagram-"+g++,r=document.createElement("div");r.className="pgn-diagram";r.id=n;r.style.width="340px";r.style.maxWidth="100%";e.appendChild(r);setTimeout(function(){const i=document.getElementById(n);if(!i)return;Chessboard(i,{position:t,draggable:!1,pieceTheme:P})},0)}class v{constructor(t){this.sourceEl=t;this.wrapper=document.createElement("div");this.wrapper.className="pgn-blog-block";this.buildFromElement();this.fig()}static isSANCore(e){return S.test(e)}static split(e){const t=e.split(/\r?\n/);const n=[],r=[];let i=!0;for(const o of t){const s=o.trim();if(i&&s.startsWith("[")&&s.endsWith("]"))n.push(o);else if(i&&s==="")i=!1;else{i=!1;r.push(o)}}const c=r.join(" ").replace(/\s+/g," ").trim();return{headerLines:n,movetext:c}}buildFromElement(){const e=this.sourceEl.textContent.trim(),{headerLines:t,movetext:n}=v.split(e),r=(t.length?t.join("\n")+"\n\n":"")+n,i=new Chess;i.load_pgn(r,{sloppy:!0});const o=i.header(),s=A(o.Result||"");this.header(o);this.dom(n+(s?" "+s:""));this.sourceEl.replaceWith(this.wrapper)}header(e){const t=(e.WhiteTitle?e.WhiteTitle+" ":"")+T(e.White||"")+(e.WhiteElo?" ("+e.WhiteElo+")":""),n=(e.BlackTitle?e.BlackTitle+" ":"")+T(e.Black||"")+(e.BlackElo?" ("+e.BlackElo+")":""),r=E(e.Date),i=(e.Event||"")+(r?", "+r:""),o=document.createElement("h3"),s=t+" \u2013 "+n;o.appendChild(document.createTextNode(s));o.appendChild(document.createElement("br"));o.appendChild(document.createTextNode(i));this.wrapper.appendChild(o)}ensureP(e,t){if(!t.container){const n=document.createElement("p");n.className=e;this.wrapper.appendChild(n);t.container=n}}handleSAN(e,t){let n=e.replace(/[^a-hKQRBN0-9=O0-]+$/g,"");n=n.replace(/0/g,"O");if(!v.isSANCore(n))return null;const r=t.chess.move(n,{sloppy:!0});if(!r){a(t.container,e+" ");return null}const i=document.createElement("span");i.className="pgn-move sticky-move";i.dataset.fen=t.chess.fen();i.textContent=e+" ";t.container.appendChild(i);return i}parseComment(e,t,n){const r=e.length;let i=t;while(i<r&&e[i]!=="}")i++;const o=e.substring(t,i);if(i<r&&e[i]==="}")i++;const s=o.split(/\s+/).filter(Boolean);let c=!1;for(let l=0;l<s.length;l++){let f=s[l].replace(/[^a-hKQRBN0-9=O0-]+$/g,"");f=f.replace(/0/g,"O");if(v.isSANCore(f)){c=!0;break}}if(!c){this.ensureP(n.type==="main"?"pgn-mainline":"pgn-variation",n);const l=o.split("[D]");for(let f=0;f<l.length;f++){const u=l[f].trim();u&&a(n.container," "+u);f<l.length-1&&D(this.wrapper,n.chess.fen())}return i}const d=new Chess(n.chess.fen());let p=document.createElement("p");p.className="pgn-comment";this.wrapper.appendChild(p);let u=0,m=o.length;while(u<m){const l=o[u];if(/\s/.test(l)){while(u<m&&/\s/.test(o[u]))u++;a(p," ");continue}let f=u;while(u<m&&!/\s/.test(o[u]))u++;const w=o.substring(f,u);if(!w)continue;if(w==="[D]"){D(this.wrapper,d.fen());p=document.createElement("p");p.className="pgn-comment";this.wrapper.appendChild(p);continue}let k=w.replace(/[^a-hKQRBN0-9=O0-]+$/g,"");k=k.replace(/0/g,"O");if(!v.isSANCore(k)){a(p,w+" ");continue}const C=d.move(k,{sloppy:!0});if(!C){a(p,w+" ");continue}const x=document.createElement("span");x.className="pgn-move sticky-move";x.dataset.fen=d.fen();x.textContent=w+" ";p.appendChild(x)}n.container=null;return i}dom(e){const t=new Chess;let n={type:"main",chess:t,container:null,parent:null},r=n,i=0,o=e.length;while(i<o){const s=e[i];if(/\s/.test(s)){while(i<o&&/\s/.test(e[i]))i++;this.ensureP(r.type==="main"?"pgn-mainline":"pgn-variation",r);a(r.container," ");continue}if(s==="("){i++;const d=new Chess(r.chess.fen());r={type:"variation",chess:d,container:null,parent:r};this.ensureP("pgn-variation",r);continue}if(s===")"){i++;if(r.parent){r=r.parent;r.container=null}continue}if(s==="{"){i=this.parseComment(e,i+1,r);continue}let c=i;while(i<o){const d=e[i];if(/\s/.test(d)||d==="("||d===")"||d==="{"||d==="}")break;i++}const d=e.substring(c,i);if(!d)continue;if(d==="[D]"){this.ensureP(r.type==="main"?"pgn-mainline":"pgn-variation",r);D(this.wrapper,r.chess.fen());r.container=null;continue}if(R.test(d)){this.ensureP(r.type==="main"?"pgn-mainline":"pgn-variation",r);a(r.container,d+" ");continue}if(M.test(d)){this.ensureP(r.type==="main"?"pgn-mainline":"pgn-variation",r);a(r.container,d+" ");continue}this.ensureP(r.type==="main"?"pgn-mainline":"pgn-variation",r);const p=this.handleSAN(d,r);if(!p)a(r.container,d+" ")}}fig(){if(window.ChessFigurine&&typeof window.ChessFigurine.run==="function"){window.ChessFigurine.run(this.wrapper);return}const e={K:"♔",Q:"♕",R:"♖",B:"♗",N:"♘"};this.wrapper.querySelectorAll(".pgn-move").forEach(t=>{const n=t.textContent,r=n.match(/^([KQRBN])(.+?)(\s*)$/);if(!r)return;const i=e[r[1]];if(!i)return;t.textContent=i+r[2]+(r[3]||"")})}}class F{static renderAll(e){const t=e||document;t.querySelectorAll("pgn").forEach(n=>new v(n))}static init(){if(!h())return;F.renderAll(document);window.PGNRenderer={run:function(e){F.renderAll(e||document.body)}}}}if(document.readyState==="loading"){document.addEventListener("DOMContentLoaded",function(){F.init()})}else{F.init()}})();
