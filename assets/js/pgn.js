(function(){"use strict";const a="https://chessboardjs.com/img/chesspieces/wikipedia/{piece}.png",b=/^([O0]-[O0](-[O0])?[+#]?|[KQRBN]?[a-h]?[1-8]?x?[a-h][1-8](=[QRBN])?[+#]?|[a-h][1-8](=[QRBN])?[+#]?)$/,c=/^(1-0|0-1|1\/2-1\/2|½-½|\*)$/,d=/^(\d+)(\.+)$/,e=/^[\+\-=∞±]+$/,f="\u00A0",g=()=>("undefined"==typeof Chess?(console.warn("pgn.js: chess.js missing"),!1):!0),h=a=>a?a.replace(/1\/2-1\/2/g,"½-½"):"",i=a=>{if(!a)return"";const b=a.split(".");return/^\d{4}$/.test(b[0])?b[0]:""},j=a=>{if(!a)return"";const b=a.indexOf(",");return-1===b?a.trim():a.substring(b+1).trim()+" "+a.substring(0,b).trim()},k=(a,b)=>{b&&a.appendChild(document.createTextNode(b))};let l=0;const m=(b,c)=>{if("undefined"==typeof Chessboard)return void console.warn("pgn.js: chessboard.js missing for diagrams");const d="pgn-diagram-"+l++,e=document.createElement("div");e.className="pgn-diagram",e.id=d,e.style.width="340px",e.style.maxWidth="100%",b.appendChild(e),setTimeout(()=>{const b=document.getElementById(d);b&&Chessboard(b,{position:c,draggable:!1,pieceTheme:a})},0)};
class n{constructor(a){this.sourceEl=a,this.wrapper=document.createElement("div"),this.wrapper.className="pgn-blog-block",this.lastLiteralToken=null,this.lastWasMove=!1,this.o(),this.y()}static z(a){return b.test(a)}static A(a){const b=a.split(/\r?\n/),c=[],d=[];let e=!0;for(const a of b){const b=a.trim();e&&b.startsWith("[")&&b.endsWith("]")?c.push(a):e&&""===b?e=!1:(e=!1,d.push(a))}return{headerLines:c,Movetext:d.join(" ").replace(/\s+/g," ").trim()}}o(){const a=this.sourceEl.textContent.trim(),{headerLines:b,Movetext:c}=n.A(a),d=(b.length?b.join("\n")+"\n\n":"")+c,e=new Chess;e.load_pgn(d,{sloppy:!0});const f=e.header(),g=h(f.Result||"");this.p(f),this.q(c+(g?" "+g:"")),this.sourceEl.replaceWith(this.wrapper)}p(a){const b=(a.WhiteTitle?a.WhiteTitle+" ":"")+j(a.White||"")+(a.WhiteElo?" ("+a.WhiteElo+")":""),c=(a.BlackTitle?a.BlackTitle+" ":"")+j(a.Black||"")+(a.BlackElo?" ("+a.BlackElo+")":""),d=i(a.Date),e=(a.Event||"")+(d?", "+d:""),f=document.createElement("h3");f.appendChild(document.createTextNode(`${b} – ${c}`)),f.appendChild(document.createElement("br")),f.appendChild(document.createTextNode(e)),this.wrapper.appendChild(f)}r(a,b){if(!a.container){const c=document.createElement("p");c.className=b,this.wrapper.appendChild(c),a.container=c}}s(a,b,c){let d=c.replace(/[^a-hKQRBN0-9=O0-]+$/g,"").replace(/0/g,"O");if(!n.z(d))return k(a.container,c+" "),this.lastWasMove=!1,null;const e=a.baseHistoryLen||0,g=a.chess.history().length,h=e+g,i=h%2===0,j2=Math.floor(h/2)+1;"main"===a.type?(i?k(a.container,j2+"."+f):a.lastWasInterrupt&&k(a.container,j2+"..."+f)):(i?k(a.container,j2+"."+f):a.lastWasInterrupt&&k(a.container,j2+"..."+f)),a.prevFen=a.chess.fen(),a.prevHistoryLen=h;const l=a.chess.move(d,{sloppy:!0});if(!l)return k(a.container,c+" "),this.lastWasMove=!1,null;a.lastWasInterrupt=!1,this.lastLiteralToken=null,this.lastWasMove=!0;const m=document.createElement("span");return m.className="pgn-move sticky-move",m.dataset.fen=a.chess.fen(),m.textContent=c+" ",a.container.appendChild(m),m}t(a,b,c){let d=b;for(;d<a.length&&a[d]!=="}";)d++;const e=a.substring(b,d).trim();a[d]==="}"&&d++;const f=e.split("[D]");for(let b=0;b<f.length;b++){const e=f[b].trim();"variation"===c.type?(this.r(c,"pgn-variation"),e&&k(c.container," "+e)):(e&&(()=>{const a=document.createElement("p");a.className="pgn-comment",k(a,e),this.wrapper.appendChild(a)})(),c.container=null),b<f.length-1&&m(this.wrapper,c.chess.fen())}return c.lastWasInterrupt=!0,this.lastLiteralToken=null,this.lastWasMove=!1,d}q(a){const b=new Chess;let f={type:"main",chess:b,container:null,parent:null,lastWasInterrupt:!1,prevFen:b.fen(),prevHistoryLen:0,baseHistoryLen:null},g=0;for(;g<a.length;){const h2=a[g];if(/\s/.test(h2)){for(;g<a.length&&/\s/.test(a[g]);)g++;this.r(f,"main"===f.type?"pgn-mainline":"pgn-variation"),k(f.container," ");continue}if("("===h2){g++;const a2=f.prevFen||f.chess.fen(),b2="number"==typeof f.prevHistoryLen?f.prevHistoryLen:f.chess.history().length;f={type:"variation",chess:new Chess(a2),container:null,parent:f,lastWasInterrupt:!0,prevFen:a2,prevHistoryLen:b2,baseHistoryLen:b2},this.r(f,"pgn-variation");continue}if(")"===h2){g++,f.parent&&(f=f.parent,f.lastWasInterrupt=!0,f.container=null);continue}if("{"===h2){g=this.t(a,g+1,f);continue}const i2=g;for(;g<a.length&&!/\s/.test(a[g])&&! "(){ }".includes(a[g]);)g++;const h3=a.substring(i2,g);if(!h3)continue;if("[D]"===h3){m(this.wrapper,f.chess.fen()),f.lastWasInterrupt=!0,f.container=null;continue}if(c.test(h3)){this.r(f,"main"===f.type?"pgn-mainline":"pgn-variation"),k(f.container,h3+" ");continue}if(d.test(h3))continue;const j3=h3.replace(/[^a-hKQRBN0-9=O0-]+$/g,"").replace(/0/g,"O"),l2=n.z(j3);if(!l2){const b3=/[A-Za-zÇĞİÖŞÜçğıöşü]/.test(h3);if(e.test(h3)&&h3===this.lastLiteralToken)continue;if(b3)"variation"===f.type?(this.r(f,"pgn-variation"),k(f.container," "+h3)):(()=>{const a=document.createElement("p");a.className="pgn-comment",k(a,h3),this.wrapper.appendChild(a)}(),f.container=null,f.lastWasInterrupt=!0);else this.r(f,"main"===f.type?"pgn-mainline":"pgn-variation"),k(f.container,h3+" ");this.lastLiteralToken=h3,this.lastWasMove=!1;continue}this.r(f,"main"===f.type?"pgn-mainline":"pgn-variation");const m2=this.s(f,h3,f);m2||k(f.container,h3+" ")}}y(){const a={K:"♔",Q:"♕",R:"♖",B:"♗",N:"♘"};this.wrapper.querySelectorAll(".pgn-move").forEach(b=>{const c=b.textContent.match(/^([KQRBN])(.+?)(\s*)$/);c&&(b.textContent=a[c[1]]+c[2]+(c[3]||""))})}}
class o{static B(a){(a||document).querySelectorAll("pgn").forEach(a=>new n(a))}static init(){g()&&(o.B(document),window.PGNRenderer={run(a){o.B(a||document.body)}})}}"loading"===document.readyState?document.addEventListener("DOMContentLoaded",()=>o.init()):o.init()})();
